"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const CSON = require("season");
const fs = require("fs");
const util_1 = require("./util");
const mjAPI = require("mathjax-node");
let isMathJaxDisabled = false;
let isMathJaxLoaded = false;
async function mathProcessor(domElements) {
    if (isMathJaxDisabled)
        return;
    loadMathJax();
    for (const elem of domElements) {
        await processHTMLElement(elem);
    }
}
exports.mathProcessor = mathProcessor;
async function processHTMLString(html) {
    if (isMathJaxDisabled) {
        return html;
    }
    loadMathJax();
    const element = document.createElement('div');
    element.innerHTML = html;
    await processHTMLElement(element);
    return element.innerHTML;
}
exports.processHTMLString = processHTMLString;
async function processHTMLElement(element) {
    const maths = element.querySelectorAll('script[type^="math/tex"]');
    for (const math of Array.from(maths)) {
        try {
            const display = math.type
                .split(';')
                .some((x) => x.trim() === 'mode=display');
            const res = await mjAPI.typeset({
                svg: true,
                format: display ? 'TeX' : 'inline-TeX',
                math: math.text,
            });
            if (res.svg)
                math.outerHTML = res.svg;
        }
        catch (e) {
            console.error(e);
        }
    }
}
function disableMathJax(disable) {
    isMathJaxDisabled = disable;
}
function loadMathJax(listener) {
    if (!isMathJaxLoaded) {
        isMathJaxLoaded = true;
        attachMathJax();
    }
    if (listener) {
        listener();
    }
}
function attachMathJax() {
    if (atom.inDevMode()) {
        atom.notifications.addInfo('Loading maths rendering engine MathJax');
    }
    configureMathJax();
}
function resetMathJax() {
    mjAPI.start();
}
exports.testing = {
    loadMathJax,
    resetMathJax,
    disableMathJax,
};
const namePattern = new RegExp(`\
^[^a-zA-Z\\d\\s]$\
|\
^[a-zA-Z]*$\
`);
function getUserMacrosPath() {
    const userMacrosPath = CSON.resolve(path.join(atom.getConfigDirPath(), 'markdown-preview-plus'));
    return userMacrosPath != null
        ? userMacrosPath
        : path.join(atom.getConfigDirPath(), 'markdown-preview-plus.cson');
}
function loadMacrosFile(filePath) {
    if (!CSON.isObjectPath(filePath)) {
        return {};
    }
    return CSON.readFileSync(filePath, function (error, object) {
        if (object === undefined) {
            object = {};
        }
        if (error !== undefined) {
            console.warn(`Error reading Latex Macros file '${filePath}': ${error.stack !== undefined ? error.stack : error}`);
            atom.notifications.addError(`Failed to load Latex Macros from '${filePath}'`, { detail: error.message, dismissable: true });
        }
        return object;
    });
}
function loadUserMacros() {
    const userMacrosPath = getUserMacrosPath();
    if (util_1.isFileSync(userMacrosPath)) {
        return loadMacrosFile(userMacrosPath);
    }
    else {
        console.debug('Creating markdown-preview-plus.cson, this is a one-time operation.');
        createMacrosTemplate(userMacrosPath);
        return loadMacrosFile(userMacrosPath);
    }
}
function createMacrosTemplate(filePath) {
    const templatePath = path.join(__dirname, '../assets/macros-template.cson');
    const templateFile = fs.readFileSync(templatePath, 'utf8');
    fs.writeFileSync(filePath, templateFile);
}
function checkMacros(macrosObject) {
    for (const name in macrosObject) {
        const value = macrosObject[name];
        if (!name.match(namePattern) || !valueMatchesPattern(value)) {
            delete macrosObject[name];
            atom.notifications.addError(`Failed to load LaTeX macro named '${name}'. Please see the [LaTeX guide](https://github.com/Galadirith/markdown-preview-plus/blob/master/LATEX.md#macro-names)`, { dismissable: true });
        }
    }
    return macrosObject;
}
function valueMatchesPattern(value) {
    if (Array.isArray(value)) {
        const macroDefinition = value[0];
        const numberOfArgs = value[1];
        if (typeof numberOfArgs === 'number') {
            return numberOfArgs % 1 === 0 && typeof macroDefinition === 'string';
        }
        else {
            return false;
        }
    }
    else if (typeof value === 'string') {
        return true;
    }
    else {
        return false;
    }
}
const configureMathJax = function () {
    let userMacros = loadUserMacros();
    if (userMacros) {
        userMacros = checkMacros(userMacros);
    }
    else {
        userMacros = {};
    }
    mjAPI.config({
        MathJax: {
            jax: ['input/TeX', 'output/SVG'],
            extensions: [],
            TeX: {
                extensions: [
                    'AMSmath.js',
                    'AMSsymbols.js',
                    'noErrors.js',
                    'noUndefined.js',
                ],
                Macros: userMacros,
            },
            messageStyle: 'none',
            showMathMenu: false,
        },
    });
    if (atom.inDevMode()) {
        atom.notifications.addSuccess('Loaded maths rendering engine MathJax');
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0aGpheC1oZWxwZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvbWF0aGpheC1oZWxwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFPQSw2QkFBNkI7QUFDN0IsK0JBQStCO0FBQy9CLHlCQUF5QjtBQUN6QixpQ0FBbUM7QUFFbkMsc0NBQXNDO0FBRXRDLElBQUksaUJBQWlCLEdBQUcsS0FBSyxDQUFBO0FBQzdCLElBQUksZUFBZSxHQUFHLEtBQUssQ0FBQTtBQVNwQixLQUFLLHdCQUF3QixXQUFtQjtJQUNyRCxFQUFFLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQztRQUFDLE1BQU0sQ0FBQTtJQUM3QixXQUFXLEVBQUUsQ0FBQTtJQUNiLEdBQUcsQ0FBQyxDQUFDLE1BQU0sSUFBSSxJQUFJLFdBQTRCLENBQUMsQ0FBQyxDQUFDO1FBQ2hELE1BQU0sa0JBQWtCLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDaEMsQ0FBQztBQUNILENBQUM7QUFORCxzQ0FNQztBQVNNLEtBQUssNEJBQTRCLElBQVk7SUFDbEQsRUFBRSxDQUFDLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDO1FBQ3RCLE1BQU0sQ0FBQyxJQUFJLENBQUE7SUFDYixDQUFDO0lBQ0QsV0FBVyxFQUFFLENBQUE7SUFDYixNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFBO0lBQzdDLE9BQU8sQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFBO0lBRXhCLE1BQU0sa0JBQWtCLENBQUMsT0FBTyxDQUFDLENBQUE7SUFFakMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUE7QUFDMUIsQ0FBQztBQVhELDhDQVdDO0FBRUQsS0FBSyw2QkFBNkIsT0FBb0I7SUFDcEQsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLGdCQUFnQixDQUNwQywwQkFBMEIsQ0FDTSxDQUFBO0lBRWxDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sSUFBSSxJQUFJLEtBQUss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QUUsQ0FBQTtJQUNqQyxFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1FBQ2YsVUFBVSxHQUFHLFdBQVcsQ0FBQyxVQUFVLENBQUMsQ0FBQTtJQUN0QyxDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDTixVQUFVLEdBQUcsRUFBRSxDQUFBO0lBQ2pCLENBQUM7SUFHRCxLQUFLLENBQUMsTUFBTSxDQUFDO1FBQ1gsT0FBTyxFQUFFO1lBQ1AsR0FBRyxFQUFFLENBQUMsV0FBVyxFQUFFLFlBQVksQ0FBQztZQUNoQyxVQUFVLEVBQUUsRUFBRTtZQUNkLEdBQUcsRUFBRTtnQkFDSCxVQUFVLEVBQUU7b0JBQ1YsWUFBWTtvQkFDWixlQUFlO29CQUNmLGFBQWE7b0JBQ2IsZ0JBQWdCO2lCQUNqQjtnQkFDRCxNQUFNLEVBQUUsVUFBVTthQUNuQjtZQUNELFlBQVksRUFBRSxNQUFNO1lBQ3BCLFlBQVksRUFBRSxLQUFLO1NBRXBCO0tBQ0YsQ0FBQyxDQUFBO0lBR0YsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNyQixJQUFJLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyx1Q0FBdUMsQ0FBQyxDQUFBO0lBQ3hFLENBQUM7QUFDSCxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvL1xuLy8gbWF0aGpheC1oZWxwZXJcbi8vXG4vLyBUaGlzIG1vZHVsZSB3aWxsIGhhbmRsZSBsb2FkaW5nIHRoZSBNYXRoSmF4IGVudmlyb25tZW50IGFuZCBwcm92aWRlIGEgd3JhcHBlclxuLy8gZm9yIGNhbGxzIHRvIE1hdGhKYXggdG8gcHJvY2VzcyBMYVRlWCBlcXVhdGlvbnMuXG4vL1xuXG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuaW1wb3J0IENTT04gPSByZXF1aXJlKCdzZWFzb24nKVxuaW1wb3J0IGZzID0gcmVxdWlyZSgnZnMnKVxuaW1wb3J0IHsgaXNGaWxlU3luYyB9IGZyb20gJy4vdXRpbCdcbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby12YXItcmVxdWlyZXNcbmltcG9ydCBtakFQSSA9IHJlcXVpcmUoJ21hdGhqYXgtbm9kZScpXG5cbmxldCBpc01hdGhKYXhEaXNhYmxlZCA9IGZhbHNlXG5sZXQgaXNNYXRoSmF4TG9hZGVkID0gZmFsc2VcblxuLy9cbi8vIFByb2Nlc3MgRE9NIGVsZW1lbnRzIGZvciBMYVRlWCBlcXVhdGlvbnMgd2l0aCBNYXRoSmF4XG4vL1xuLy8gQHBhcmFtIGRvbUVsZW1lbnRzIEFuIGFycmF5IG9mIERPTSBlbGVtZW50cyB0byBiZSBwcm9jZXNzZWQgYnkgTWF0aEpheC4gU2VlXG4vLyAgIFtlbGVtZW50XShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvZWxlbWVudCkgZm9yXG4vLyAgIGRldGFpbHMgb24gRE9NIGVsZW1lbnRzLlxuLy9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBtYXRoUHJvY2Vzc29yKGRvbUVsZW1lbnRzOiBOb2RlW10pIHtcbiAgaWYgKGlzTWF0aEpheERpc2FibGVkKSByZXR1cm5cbiAgbG9hZE1hdGhKYXgoKVxuICBmb3IgKGNvbnN0IGVsZW0gb2YgZG9tRWxlbWVudHMgYXMgSFRNTEVsZW1lbnRbXSkge1xuICAgIGF3YWl0IHByb2Nlc3NIVE1MRWxlbWVudChlbGVtKVxuICB9XG59XG5cbi8vXG4vLyBQcm9jZXNzIG1hdGhzIGluIEhUTUwgZnJhZ21lbnQgd2l0aCBNYXRoSmF4XG4vL1xuLy8gQHBhcmFtIGh0bWwgQSBIVE1MIGZyYWdtZW50IHN0cmluZ1xuLy8gQHBhcmFtIGNhbGxiYWNrIEEgY2FsbGJhY2sgbWV0aG9kIHRoYXQgYWNjZXB0cyBhIHNpbmdsZSBwYXJhbWV0ZXIsIGEgSFRNTFxuLy8gICBmcmFnbWVudCBzdHJpbmcgdGhhdCBpcyB0aGUgcmVzdWx0IG9mIGh0bWwgcHJvY2Vzc2VkIGJ5IE1hdGhKYXhcbi8vXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcHJvY2Vzc0hUTUxTdHJpbmcoaHRtbDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgaWYgKGlzTWF0aEpheERpc2FibGVkKSB7XG4gICAgcmV0dXJuIGh0bWxcbiAgfVxuICBsb2FkTWF0aEpheCgpXG4gIGNvbnN0IGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKVxuICBlbGVtZW50LmlubmVySFRNTCA9IGh0bWxcblxuICBhd2FpdCBwcm9jZXNzSFRNTEVsZW1lbnQoZWxlbWVudClcblxuICByZXR1cm4gZWxlbWVudC5pbm5lckhUTUxcbn1cblxuYXN5bmMgZnVuY3Rpb24gcHJvY2Vzc0hUTUxFbGVtZW50KGVsZW1lbnQ6IEhUTUxFbGVtZW50KSB7XG4gIGNvbnN0IG1hdGhzID0gZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKFxuICAgICdzY3JpcHRbdHlwZV49XCJtYXRoL3RleFwiXScsXG4gICkgYXMgTm9kZUxpc3RPZjxIVE1MU2NyaXB0RWxlbWVudD5cblxuICBmb3IgKGNvbnN0IG1hdGggb2YgQXJyYXkuZnJvbShtYXRocykpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZGlzcGxheSA9IG1hdGgudHlwZVxuICAgICAgICAuc3BsaXQoJzsnKVxuICAgICAgICAuc29tZSgoeCkgPT4geC50cmltKCkgPT09ICdtb2RlPWRpc3BsYXknKVxuICAgICAgY29uc3QgcmVzID0gYXdhaXQgbWpBUEkudHlwZXNldCh7XG4gICAgICAgIHN2ZzogdHJ1ZSxcbiAgICAgICAgZm9ybWF0OiBkaXNwbGF5ID8gJ1RlWCcgOiAnaW5saW5lLVRlWCcsXG4gICAgICAgIG1hdGg6IG1hdGgudGV4dCxcbiAgICAgIH0pXG4gICAgICBpZiAocmVzLnN2ZykgbWF0aC5vdXRlckhUTUwgPSByZXMuc3ZnXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgY29uc29sZS5lcnJvcihlKVxuICAgIH1cbiAgfVxufVxuXG4vLyBGb3IgdGVzdGluZ1xuZnVuY3Rpb24gZGlzYWJsZU1hdGhKYXgoZGlzYWJsZTogYm9vbGVhbikge1xuICBpc01hdGhKYXhEaXNhYmxlZCA9IGRpc2FibGVcbn1cblxuLy9cbi8vIExvYWQgTWF0aEpheCBlbnZpcm9ubWVudFxuLy9cbi8vIEBwYXJhbSBsaXN0ZW5lciBtZXRob2QgdG8gY2FsbCB3aGVuIHRoZSBNYXRoSmF4IHNjcmlwdCB3YXMgYmVlblxuLy8gICBsb2FkZWQgdG8gdGhlIHdpbmRvdy4gVGhlIG1ldGhvZCBpcyBwYXNzZWQgbm8gYXJndW1lbnRzLlxuLy9cbmZ1bmN0aW9uIGxvYWRNYXRoSmF4KGxpc3RlbmVyPzogKCkgPT4gYW55KSB7XG4gIGlmICghaXNNYXRoSmF4TG9hZGVkKSB7XG4gICAgaXNNYXRoSmF4TG9hZGVkID0gdHJ1ZVxuICAgIGF0dGFjaE1hdGhKYXgoKVxuICB9XG4gIGlmIChsaXN0ZW5lcikge1xuICAgIGxpc3RlbmVyKClcbiAgfVxufVxuXG4vL1xuLy8gQXR0YWNoIG1haW4gTWF0aEpheCBzY3JpcHQgdG8gdGhlIGRvY3VtZW50XG4vL1xuZnVuY3Rpb24gYXR0YWNoTWF0aEpheCgpIHtcbiAgLy8gTm90aWZ5IHVzZXIgTWF0aEpheCBpcyBsb2FkaW5nXG4gIGlmIChhdG9tLmluRGV2TW9kZSgpKSB7XG4gICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEluZm8oJ0xvYWRpbmcgbWF0aHMgcmVuZGVyaW5nIGVuZ2luZSBNYXRoSmF4JylcbiAgfVxuXG4gIC8vIEF0dGFjaCBNYXRoSmF4IHNjcmlwdFxuICBjb25maWd1cmVNYXRoSmF4KClcbn1cblxuLy9cbi8vIFJlbW92ZSBNYXRoSmF4IGZyb20gdGhlIGRvY3VtZW50IGFuZCByZXNldCBhdHRhY2ggbWV0aG9kXG4vL1xuZnVuY3Rpb24gcmVzZXRNYXRoSmF4KCkge1xuICBtakFQSS5zdGFydCgpXG59XG5cbmV4cG9ydCBjb25zdCB0ZXN0aW5nID0ge1xuICBsb2FkTWF0aEpheCxcbiAgcmVzZXRNYXRoSmF4LFxuICBkaXNhYmxlTWF0aEpheCxcbn1cblxuLy8gcHJpdmF0ZVxuXG4vL1xuLy8gRGVmaW5lIHNvbWUgZnVuY3Rpb25zIHRvIGhlbHAgZ2V0IGEgaG9sZCBvZiB0aGUgdXNlcidzIExhdGV4XG4vLyBNYWNyb3MuXG4vL1xuY29uc3QgbmFtZVBhdHRlcm4gPSBuZXcgUmVnRXhwKGBcXFxuXlteYS16QS1aXFxcXGRcXFxcc10kXFxcbnxcXFxuXlthLXpBLVpdKiRcXFxuYCkgLy8gbGV0dGVycywgYnV0IG5vIG51bWVyYWxzLlxuXG5mdW5jdGlvbiBnZXRVc2VyTWFjcm9zUGF0aCgpOiBzdHJpbmcge1xuICBjb25zdCB1c2VyTWFjcm9zUGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkIHwgbnVsbCA9IENTT04ucmVzb2x2ZShcbiAgICBwYXRoLmpvaW4oYXRvbS5nZXRDb25maWdEaXJQYXRoKCksICdtYXJrZG93bi1wcmV2aWV3LXBsdXMnKSxcbiAgKVxuICByZXR1cm4gdXNlck1hY3Jvc1BhdGggIT0gbnVsbFxuICAgID8gdXNlck1hY3Jvc1BhdGhcbiAgICA6IHBhdGguam9pbihhdG9tLmdldENvbmZpZ0RpclBhdGgoKSwgJ21hcmtkb3duLXByZXZpZXctcGx1cy5jc29uJylcbn1cblxuZnVuY3Rpb24gbG9hZE1hY3Jvc0ZpbGUoZmlsZVBhdGg6IHN0cmluZyk6IG9iamVjdCB7XG4gIGlmICghQ1NPTi5pc09iamVjdFBhdGgoZmlsZVBhdGgpKSB7XG4gICAgcmV0dXJuIHt9XG4gIH1cbiAgcmV0dXJuIENTT04ucmVhZEZpbGVTeW5jKGZpbGVQYXRoLCBmdW5jdGlvbihlcnJvcj86IEVycm9yLCBvYmplY3Q/OiBvYmplY3QpIHtcbiAgICBpZiAob2JqZWN0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIG9iamVjdCA9IHt9XG4gICAgfVxuICAgIGlmIChlcnJvciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgIGBFcnJvciByZWFkaW5nIExhdGV4IE1hY3JvcyBmaWxlICcke2ZpbGVQYXRofSc6ICR7XG4gICAgICAgICAgZXJyb3Iuc3RhY2sgIT09IHVuZGVmaW5lZCA/IGVycm9yLnN0YWNrIDogZXJyb3JcbiAgICAgICAgfWAsXG4gICAgICApXG4gICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoXG4gICAgICAgIGBGYWlsZWQgdG8gbG9hZCBMYXRleCBNYWNyb3MgZnJvbSAnJHtmaWxlUGF0aH0nYCxcbiAgICAgICAgeyBkZXRhaWw6IGVycm9yLm1lc3NhZ2UsIGRpc21pc3NhYmxlOiB0cnVlIH0sXG4gICAgICApXG4gICAgfVxuICAgIHJldHVybiBvYmplY3RcbiAgfSlcbn1cblxuZnVuY3Rpb24gbG9hZFVzZXJNYWNyb3MoKSB7XG4gIGNvbnN0IHVzZXJNYWNyb3NQYXRoID0gZ2V0VXNlck1hY3Jvc1BhdGgoKVxuICBpZiAoaXNGaWxlU3luYyh1c2VyTWFjcm9zUGF0aCkpIHtcbiAgICByZXR1cm4gbG9hZE1hY3Jvc0ZpbGUodXNlck1hY3Jvc1BhdGgpXG4gIH0gZWxzZSB7XG4gICAgY29uc29sZS5kZWJ1ZyhcbiAgICAgICdDcmVhdGluZyBtYXJrZG93bi1wcmV2aWV3LXBsdXMuY3NvbiwgdGhpcyBpcyBhIG9uZS10aW1lIG9wZXJhdGlvbi4nLFxuICAgIClcbiAgICBjcmVhdGVNYWNyb3NUZW1wbGF0ZSh1c2VyTWFjcm9zUGF0aClcbiAgICByZXR1cm4gbG9hZE1hY3Jvc0ZpbGUodXNlck1hY3Jvc1BhdGgpXG4gIH1cbn1cblxuZnVuY3Rpb24gY3JlYXRlTWFjcm9zVGVtcGxhdGUoZmlsZVBhdGg6IHN0cmluZykge1xuICBjb25zdCB0ZW1wbGF0ZVBhdGggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vYXNzZXRzL21hY3Jvcy10ZW1wbGF0ZS5jc29uJylcbiAgY29uc3QgdGVtcGxhdGVGaWxlID0gZnMucmVhZEZpbGVTeW5jKHRlbXBsYXRlUGF0aCwgJ3V0ZjgnKVxuICBmcy53cml0ZUZpbGVTeW5jKGZpbGVQYXRoLCB0ZW1wbGF0ZUZpbGUpXG59XG5cbmZ1bmN0aW9uIGNoZWNrTWFjcm9zKG1hY3Jvc09iamVjdDogb2JqZWN0KSB7XG4gIGZvciAoY29uc3QgbmFtZSBpbiBtYWNyb3NPYmplY3QpIHtcbiAgICBjb25zdCB2YWx1ZSA9IG1hY3Jvc09iamVjdFtuYW1lXVxuICAgIGlmICghbmFtZS5tYXRjaChuYW1lUGF0dGVybikgfHwgIXZhbHVlTWF0Y2hlc1BhdHRlcm4odmFsdWUpKSB7XG4gICAgICBkZWxldGUgbWFjcm9zT2JqZWN0W25hbWVdXG4gICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoXG4gICAgICAgIGBGYWlsZWQgdG8gbG9hZCBMYVRlWCBtYWNybyBuYW1lZCAnJHtuYW1lfScuIFBsZWFzZSBzZWUgdGhlIFtMYVRlWCBndWlkZV0oaHR0cHM6Ly9naXRodWIuY29tL0dhbGFkaXJpdGgvbWFya2Rvd24tcHJldmlldy1wbHVzL2Jsb2IvbWFzdGVyL0xBVEVYLm1kI21hY3JvLW5hbWVzKWAsXG4gICAgICAgIHsgZGlzbWlzc2FibGU6IHRydWUgfSxcbiAgICAgIClcbiAgICB9XG4gIH1cbiAgcmV0dXJuIG1hY3Jvc09iamVjdFxufVxuXG5mdW5jdGlvbiB2YWx1ZU1hdGNoZXNQYXR0ZXJuKHZhbHVlOiBhbnkpIHtcbiAgLy8gRGlmZmVyZW50IGNoZWNrIGJhc2VkIG9uIHdoZXRoZXIgdmFsdWUgaXMgc3RyaW5nIG9yIGFycmF5XG4gIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgIGNvbnN0IG1hY3JvRGVmaW5pdGlvbiA9IHZhbHVlWzBdXG4gICAgY29uc3QgbnVtYmVyT2ZBcmdzID0gdmFsdWVbMV1cbiAgICBpZiAodHlwZW9mIG51bWJlck9mQXJncyA9PT0gJ251bWJlcicpIHtcbiAgICAgIHJldHVybiBudW1iZXJPZkFyZ3MgJSAxID09PSAwICYmIHR5cGVvZiBtYWNyb0RlZmluaXRpb24gPT09ICdzdHJpbmcnXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cbiAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7XG4gICAgcmV0dXJuIHRydWVcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gZmFsc2VcbiAgfVxufVxuXG4vLyBDb25maWd1cmUgTWF0aEpheCBlbnZpcm9ubWVudC4gU2ltaWxhciB0byB0aGUgVGVYLUFNU19IVE1MIGNvbmZpZ3VyYXRpb24gd2l0aFxuLy8gYSBmZXcgdW5uZWNlc3NhcnkgZmVhdHVyZXMgc3RyaXBwZWQgYXdheVxuLy9cbmNvbnN0IGNvbmZpZ3VyZU1hdGhKYXggPSBmdW5jdGlvbigpIHtcbiAgbGV0IHVzZXJNYWNyb3MgPSBsb2FkVXNlck1hY3JvcygpXG4gIGlmICh1c2VyTWFjcm9zKSB7XG4gICAgdXNlck1hY3JvcyA9IGNoZWNrTWFjcm9zKHVzZXJNYWNyb3MpXG4gIH0gZWxzZSB7XG4gICAgdXNlck1hY3JvcyA9IHt9XG4gIH1cblxuICAvLyBOb3cgQ29uZmlndXJlIE1hdGhKYXhcbiAgbWpBUEkuY29uZmlnKHtcbiAgICBNYXRoSmF4OiB7XG4gICAgICBqYXg6IFsnaW5wdXQvVGVYJywgJ291dHB1dC9TVkcnXSxcbiAgICAgIGV4dGVuc2lvbnM6IFtdLFxuICAgICAgVGVYOiB7XG4gICAgICAgIGV4dGVuc2lvbnM6IFtcbiAgICAgICAgICAnQU1TbWF0aC5qcycsXG4gICAgICAgICAgJ0FNU3N5bWJvbHMuanMnLFxuICAgICAgICAgICdub0Vycm9ycy5qcycsXG4gICAgICAgICAgJ25vVW5kZWZpbmVkLmpzJyxcbiAgICAgICAgXSxcbiAgICAgICAgTWFjcm9zOiB1c2VyTWFjcm9zLFxuICAgICAgfSxcbiAgICAgIG1lc3NhZ2VTdHlsZTogJ25vbmUnLFxuICAgICAgc2hvd01hdGhNZW51OiBmYWxzZSxcbiAgICAgIC8vIHNraXBTdGFydHVwVHlwZXNldDogdHJ1ZSxcbiAgICB9LFxuICB9KVxuXG4gIC8vIE5vdGlmeSB1c2VyIE1hdGhKYXggaGFzIGxvYWRlZFxuICBpZiAoYXRvbS5pbkRldk1vZGUoKSkge1xuICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRTdWNjZXNzKCdMb2FkZWQgbWF0aHMgcmVuZGVyaW5nIGVuZ2luZSBNYXRoSmF4JylcbiAgfVxufVxuIl19